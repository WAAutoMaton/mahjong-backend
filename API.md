# Mahjong-backend API说明

本程序为立直麻将后端，使用 stdin/stdout 进行交互，数据交换格式为 json。

以下将本程序称为“后端”，将与本程序交互的程序称为“前端”。

每次程序启动视为一局游戏的开始，一局游戏结束后程序自动停止。局间信息（点数结算等）由前端进行维护。

文档中的日麻术语的英文主要参考欧洲麻将协会的翻译。

### 数据交换格式说明

前后端间使用标准 json 文档格式进行交互，要求前端每次向后端传输的 json 文档内部不含回车空格制表符等不可见字符（也就是说仅文档末一个回车）；后端向前端传输的数据也有同样的保证。

本文档中考虑到可读性，json 示例中带有注释和文档内部换行空格制表符，但实际数据交换中不含这些内容。

### 预定义类型

本节定义几个较频繁使用到的数据结构。

#### 数组

对于一个数组 ``[<int>,<int>,...,<int>]``，本文使用 ``<int>[N]`` 表示，当数组数量不定时 N 省略。

没有特殊说明时数组均从０开始编号

#### Tile

相当于 ``<string>``，但仅用于表示一张牌。格式与雀魂相同

#### Group

表示一组（副露的）面子。

```plain
{
    "Type": <int>, //类型：0,1,2,3,4分别表示刻子，顺子，暗杠，大明杠，加杠
    "From": <int>, //从哪一家得到的（若是暗杠则为自己）（东南西北家分别为0~3）
    "Tile": []<Tile>, //一个数组，表示这个面子的组成
    "CallingTile": <Tile>, //拿到的是哪一张牌
}
```



### 后端返回结果格式

```plain
{
    "Error": <int>,
    "ErrorString": <string>,
    "Title": {...},
    ... //剩余内容根据具体情况而定
}
```

#### Error 和 ErrorString

Error 值表示后端是否遇到了致命错误，若值为 0 ，表示没有错误，否则表示遇到了致命错误，后端将立即结束运行。

若 Error 为 0 ，则 ErrorString 为空，否则将（可能）包含具体错误的说明。

具体错误码含义如下：

* -1: 后端遇到了未知错误。若遇到这个错误，请在issue区提出并附上此局的数据。

* -2: 前端传递的 json 格式错误。

* -3: 前端传递的数据与期望不一致，包括缺少了某项值、某项值的类型不正确、某项值不正确等。

#### Title

当前场上所有牌的状态，遇到错误时此项值无意义，否则按如下格式给出：
```plain
{
	"Wall": <Tile>[136],  //牌山，从左到右为124张普通牌，交替的5张宝牌指示牌和壁牌，4张岭上牌（顺序和雀魂一致）
	"MD5": <string>, // 牌山的MD5（生成算法和雀魂一致）
	“DoraIndicatorCount”: <int>, // 当前已经翻开了几张宝牌指示牌
	"ReplacementTileCount": <int>, // 当前已经拿掉了几张岭上牌
	"WallCount": <int>, // 普通牌已经摸走了几张
	"Player": 
	{
		"HandTile": <Tile>[], //手牌，为一个数组，含若干个元素
		"NowTile": <Tile>, //当前摸到的牌，若不是当前玩家出牌则为空
		"DiscardTile": <Tile>[], //牌河，为一个数组，含若干个元素
		"ReadHand": <int>, //是否听牌，0: 否，1: 是， 2:振听
		"Riichi": <int>, //表示该玩家的立直宣言牌为牌河中的第几张（若该玩家未立直则为-1，已立直但没有立直宣言牌则为-2）
		"Group": <Group>[], //该玩家副露牌列表
	}[4], // 一个数组，含4个元素，分别表示每名玩家的牌，按东南西北的顺序给出。
}
```

### 启动

程序启动时，前端需向后端传输该局的基本信息，包括：场风，连庄次数。

具体格式如下：

```plain
{
	"PrevailingWind": <int>, // 当前局场风：整数 0~3 分别表示东、南、西、北风场
	"RemainingDealer": <int>,  //当前局的连庄次数  
    "Riichi": <bool>[4] //玩家的点数是否足够立直(按东南西北家顺序给出)
}
```

然后从后端返回数据开始正式开始游戏

### 游戏进行中

每次后端返回的数据如下：

```plain
{
	... //标准数据
	"Action":{
		"Type": <int>, // 动作类型： 0:打出一张牌； 1:吃碰杠； 2:和牌 3: 九种九牌 4: 立直
		"Player": 
		{ // type为0时
        	"ID": <int>, //哪个玩家
			"CanDiscard": <bool>[], //手牌是否能打出（按从左到右顺序） （刚摸到的牌视为最后一张），此项仅type=0时有意义
			"Group": <Group>[], // 可以吃碰杠的面子，此项仅type=1时有意义
		}[], //要执行动作的玩家数组
	}
}

```

然后前端要返回如下内容

```plain
{ // type为0时
    "Discard": <int>, //打出哪一张牌
}
或
{ // type为1时
    "Discard": <int>, //打出哪一个面子（若为-1表示放弃）
}
或
{ //type为2或3或4时
    "OK": <bool>, //是否选择和牌/流局/立直
}
[] //一个数组，每个元素与player数组中的元素一一对应
```

### 终局

终局时，后端返回如下数据，然后结束运行

```plain
{
	... // 标准数据
	"End": {
		"Player": {
			"IsWin": <int>, // 玩家是否和牌： 0:未和牌 1:荣和 2:自摸和 3:流局满贯 4:荒牌流局（未听牌） 5:荒牌流局（听牌） TODO:特殊流局
			"Yaku": <int>[], // 玩家和了哪些役，役种的编号见下（未和牌时此项值无意义）
			"Minipoints": <int>, //玩家此局符数（未和牌时此项值无意义）
			"Score": <int>, // 玩家此局得分情况
		}[4]
	}
}
```


### 役种表

役种使用3位整数表示，每种役型一个编号（对于食下役会有两个）。

详细列表如下：

| 编号 | 名称     | 番数 | 说明                                                         |
| ---- | -------- | ---- | ------------------------------------------------------------ |
| 100  | 立直     | 1    | 门清，宣布立直而和牌。                                       |
| 101  | 双立直   | 1    | 门清，开局打第一张牌就宣布立直。注：如果之前有玩家吃碰杠牌则无效。 |
| 102  | 一发     | 1    | 宣布立直以后，第一轮以内（包括自摸）和牌。注：如果期间有玩家吃碰杠牌则无效。 |
| 103  | 门清自摸 | 1    | 门清，可以有暗杠，自摸而和牌。                               |

